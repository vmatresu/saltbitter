name: Auto-Complete Task on PR Merge

on:
  pull_request:
    types: [closed]
    branches:
      - develop
      - main

jobs:
  complete-task:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0

      - name: Extract task ID from PR
        id: extract-task
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BRANCH="${{ github.event.pull_request.head.ref }}"
          PR_BODY="${{ github.event.pull_request.body }}"

          # Try to extract TASK-XXX from title, branch, or body
          TASK_ID=$(echo "$PR_TITLE $PR_BRANCH $PR_BODY" | grep -oE 'TASK-[0-9]{3}' | head -1 || echo "")

          if [ -z "$TASK_ID" ]; then
            echo "No task ID found in PR"
            echo "has_task=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "task_id=$TASK_ID" >> $GITHUB_OUTPUT
          echo "has_task=true" >> $GITHUB_OUTPUT
          echo "Found task: $TASK_ID"

      - name: Complete task
        if: steps.extract-task.outputs.has_task == 'true'
        id: complete-task
        env:
          TASK_ID: ${{ steps.extract-task.outputs.task_id }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_MERGED_AT: ${{ github.event.pull_request.merged_at }}
          AGENT_ID: ${{ github.event.pull_request.user.login }}
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
        run: |
          # Find the task file in claimed/, tasks/, or completed/
          PROJECT=""
          TASK_FILE=""
          ALREADY_COMPLETED=false

          # Check claimed/ directory
          for proj in .agents/claimed/*/; do
            if [ -f "${proj}${TASK_ID}.toon" ]; then
              PROJECT=$(basename "$proj")
              TASK_FILE="${proj}${TASK_ID}.toon"
              break
            fi
          done

          # Check tasks/ directory
          if [ -z "$TASK_FILE" ]; then
            for proj in .agents/projects/*/tasks/; do
              if [ -f "${proj}${TASK_ID}.toon" ]; then
                PROJECT=$(basename $(dirname $(dirname "$proj")))
                TASK_FILE="${proj}${TASK_ID}.toon"
                break
              fi
            done
          fi

          # Check completed/ directory (task may have been manually completed)
          if [ -z "$TASK_FILE" ]; then
            for proj in .agents/completed/*/; do
              if [ -f "${proj}${TASK_ID}.toon" ]; then
                PROJECT=$(basename "$proj")
                TASK_FILE="${proj}${TASK_ID}.toon"
                ALREADY_COMPLETED=true
                echo "âš ï¸  Task already in completed/ - likely manually completed by agent"
                break
              fi
            done
          fi

          if [ -z "$TASK_FILE" ]; then
            echo "âŒ Task file not found for $TASK_ID in any directory"
            exit 0
          fi

          echo "Found task file: $TASK_FILE"
          echo "Project: $PROJECT"

          # Only move and add metadata if not already completed
          if [ "$ALREADY_COMPLETED" = false ]; then
            # Create completed directory if needed
            mkdir -p ".agents/completed/$PROJECT"

            # Move task to completed
            COMPLETED_FILE=".agents/completed/$PROJECT/${TASK_ID}.toon"
            mv "$TASK_FILE" "$COMPLETED_FILE"

            # Add completion metadata
            cat >> "$COMPLETED_FILE" <<EOF

          completion:
           status: completed
           completed_at: $PR_MERGED_AT
           completed_by: $AGENT_ID
           pr_url: $PR_URL
           pr_number: $PR_NUMBER
           merged_to: $BASE_BRANCH
          EOF

            echo "âœ… Task $TASK_ID marked as completed"
          else
            echo "â„¹ï¸  Task $TASK_ID already completed - skipping move/metadata"
          fi

          # Make unblock script executable and run it
          chmod +x .agents/scripts/unblock-tasks.sh
          echo ""
          echo "Running dependency check to unblock tasks..."
          UNBLOCK_OUTPUT=$(.agents/scripts/unblock-tasks.sh "$PROJECT")
          echo "$UNBLOCK_OUTPUT"

          # Extract unblocked count from script output
          UNBLOCKED=$(echo "$UNBLOCK_OUTPUT" | grep "Tasks unblocked:" | awk '{print $3}')
          echo "unblocked_count=$UNBLOCKED" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.extract-task.outputs.has_task == 'true'
        env:
          TASK_ID: ${{ steps.extract-task.outputs.task_id }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .agents/completed/ .agents/claimed/ .agents/projects/
          git commit -m "[AUTO-COMPLETE] Mark $TASK_ID as completed (PR #$PR_NUMBER)

          Automatically completed task after PR merge.

          PR: ${{ github.event.pull_request.html_url }}
          Merged to: ${{ github.event.pull_request.base.ref }}

          ğŸ¤– Automated by GitHub Actions" || echo "No changes to commit"

          git push origin ${{ github.event.pull_request.base.ref }}

      - name: Comment on PR
        if: steps.extract-task.outputs.has_task == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `âœ… **Task ${{ steps.extract-task.outputs.task_id }} automatically marked as completed!**

              ğŸ“ Moved to: \`.agents/completed/\`
              ğŸ”“ Unblocked tasks: ${{ steps.complete-task.outputs.unblocked_count || 0 }}

              The task is now marked complete and dependent tasks have been unblocked.`
            });
