task:
 id: TASK-013
 project: dating-platform
 title: Implement Stripe subscription system
 type: backend
 priority: 6
 status: ready

description:
 summary: Build subscription management with Stripe for Free/Premium/Elite tiers
 details: |
  Create subscription infrastructure:
  - Stripe integration for recurring subscriptions
  - 3 tiers: Free ($0), Premium ($12.99), Elite ($29.99)
  - Subscription creation and management
  - Webhook handling for subscription events
  - Prorated upgrades and downgrades
  - Cancellation with end-of-period access
  - Payment method management
  - Subscription status tracking
  - Revenue metrics and MRR calculation
  - Failed payment retry logic

acceptance_criteria[10]:
 POST /api/subscriptions creates Stripe subscription
 Stripe webhook handles subscription.created events
 Stripe webhook handles subscription.updated events
 Stripe webhook handles invoice.payment_failed events
 PUT /api/subscriptions/{id} handles upgrades/downgrades
 Prorated billing calculated correctly
 DELETE /api/subscriptions/{id} cancels at period end
 Users can update payment methods
 Subscription status synced to database
 MRR calculated from active subscriptions

dependencies:
 required[2]:
  TASK-001
  TASK-002
 blocks[2]:
  TASK-011
  TASK-014

context:
 files_to_create[9]:
  backend/services/payment/main.py
  backend/services/payment/stripe_client.py
  backend/services/payment/subscriptions.py
  backend/services/payment/webhooks.py
  backend/services/payment/models.py
  backend/services/payment/schemas.py
  backend/services/payment/metrics.py
  backend/services/payment/tests/test_subscriptions.py
  backend/services/payment/tests/test_webhooks.py

technical_details:
 stack[3]:
  FastAPI 0.104+
  Stripe Python SDK 7.0+
  SQLAlchemy 2.0
 endpoints[6]:
  POST /api/subscriptions
  GET /api/subscriptions/{user_id}
  PUT /api/subscriptions/{id}
  DELETE /api/subscriptions/{id}
  POST /api/webhooks/stripe
  GET /api/subscriptions/metrics (admin)
 subscription_tiers[3]{name,price_usd,stripe_price_id}:
  Free,0.00,null
  Premium,12.99,price_premium_monthly
  Elite,29.99,price_elite_monthly

stripe_webhooks[6]:
 subscription.created
 subscription.updated
 subscription.deleted
 invoice.payment_succeeded
 invoice.payment_failed
 customer.subscription.trial_will_end

metadata:
 created_by: architect-agent
 created_at: 2025-11-17T17:12:00Z
 estimated_hours: 14
 complexity: high
